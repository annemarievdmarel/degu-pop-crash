---
title: "covariates"
author: "Annemarie van der Marel"
date: "2023-12-15"
output: pdf_document
---



Environmental variables
independent  and multiple estimates supports our hypothesis that drought affects vegetation production and hence food availability:

The values of NDVI indicate presence of green vegetation /indicator of vegetation greenness while LAI quantifies the amount of leaf material in a canopy. So, LAI is a better indicator of food availability.

The SMAP soil moisture is available only after 2015, but it clearly indicates the severe drought conditions in 2018. (perhaps as supplemental material)

Evapotranspiration contains both evaporation and transpiration, so I don't think I can use it as a proxy of soil moisture alone, but as an indicator of the effect of soil moisture.

The GPP values indicate  the total influx of carbon into an ecosystem through the photosynthetic fixation of CO2 and represents biomass production. So, indirectly support vegetation activity, partially contribute to E through transpiration.



# load libraries
```{r include=FALSE}
library(tidyverse)
library(paletteer)
library(ggrepel)
library(ggpubr)
library(dplyr)
library(gghighlight)
```


# import data
```{r}

capture_sum <- read.csv("results/capture_summary.csv") %>%
  select(-X, -idsmissing_select, -idstrapped_select, -idsmissing_after) %>%
  dplyr::rename(trapsession=season, 
         window=month)

# seasonkey <- read.csv("./data/seasonkey.csv") %>%
#   select(-X) %>%
#   add_row(seasonkey=0, seasonid="spring_oct_2008", season="breeding", window="oct", year=2008, .before = 1) %>%
#   add_row(seasonkey=-1, seasonid="fall_jun_2008",season="nonbreeding", window="jun", year=2008, .before = 1)
  

seasonkey_month <- read.csv("./data/seasonkey_month_v2.csv") 

# environmental data
temp_raw <- read.csv("./data/monthly_data_Pudahuel.csv") 
temp_raw$precipitation_mm[temp_raw$precipitation_mm==-999.0] <- NA


enso_raw <- read.csv("./data/El Niño-Southern Oscillation.csv")

# envirownmental data _ MODIS
modis_day <- read.csv("results/MODIS_ET_GPP_LAI_dailyn_final.csv") %>% 
  dplyr::select(-X) %>% 
  dplyr::rename(year=Year,
        month=Month) 
 
modis_month <- read.csv("data/MODIS_monthly_data.csv") %>% # for monthly plots
  #dplyr::select(-X) %>% 
  dplyr::rename(year=Year,
        month=Month) 

```


I first had dry from October-March and wet from April-September, but April and May do not really show that much rainfall, while June through September represent the breeding season and October through May juvenile emergence, summer survival, and preparation for the breeding season, early mating. Although in some years with favorable conditions, a second litter in the early summer can be observed. We just do not have the trapping data to include this season. 

# helper functions
```{r}
years <- c(2009:2020)
```


```{r}

library(colorblindr)
library(paletteer)
library(impressionist.colors)

paletteer::palettes_d_names
paletteer_d(`"Manu::Kea"`)
  paletteer_d(`"colorBlindness::paletteMartin"`)
paletteer_d(`"impressionist.colors::korenveld_onder_onweerslucht"`)
paletteer_d(`"impressionist.colors::les_nympheas"`)
paletteer_d(`"impressionist.colors::de_slaapkamer"`)


impressionist.colors::palette.summary()


colors<- paletteer_d(`"impressionist.colors::korenveld_onder_onweerslucht"`, 12)

#colors <-  thematic::okabe_ito(12) "#E69F00" "#009E73" "#0072B2" "#CC79A7" "#999999" "#D55E00" "#F0E442" "#56B4E9"


colorsXyear <- paletteer::scale_colour_paletteer_d("rcartocolor::Safe")
colorsXyear <-paletteer::paletteer_d("rcartocolor::Safe")

```


# Weather covariates
## yearly temp and rainfall

```{r}
annual <- temp_raw %>%
  group_by(year) %>%
  dplyr::summarize(temp_avg=mean(avgT_C), 
            temp_max=mean(maxT_C),
            rain_mm=sum(precipitation_mm, na.rm = T),
            temp_cv=sd(avgT_C, na.rm = T) / mean(avgT_C, na.rm = T), 
            rain_cv=sd(precipitation_mm, na.rm = T)/mean(precipitation_mm, na.rm = T))
head(annual)
#annual$year <- as.integer(annual$year)
```

Percent Decline=( Original Value -New Value)/Original value *100

 
```{r}
# average rain_sum 1976-2008
meanprior <- annual %>% 
  filter(year<2009) %>% 
  summarize(mean_rain=mean(rain_mm))
  
# average rainfall 2009-2019
meanstudy<- annual %>% 
  filter(between(year, 2009, 2019)) %>% 
  summarize(mean_rain=mean(rain_mm))

percdecline <- (meanprior$mean_rain-meanstudy$mean_rain)/meanprior$mean_rain *100
```


## monthly temperature and rainfall
```{r}
month_num <- c(1:12)
month <- c("jan", "feb", "mar", "apr", "may", "jun", 
           "jul", "aug", "sep", "oct", "nov", "dec")

months <- data.frame(month, month_num)
```

## plots monthly average study period

```{r temp+rain 2009-2020}

range(temp_raw$avgT_C)

plot_temp_month <-  temp_raw %>%
  filter(year>2008) %>%
  ggplot(aes(x=month, y=avgT_C, group=as.factor(year), colour=as.factor(year))) +   geom_rect( aes( xmin = 5.9,  xmax = 9.9,
      ymin = 0, ymax =25),
    fill = alpha("lightgrey", 0.2), color="lightgrey") +
  geom_line() +   geom_point() +
  theme_classic() +
  #facet_wrap(~year) +
  scale_y_continuous(limits=c(0, 25)) +
  scale_x_continuous(limits=c(1,12), breaks = 1:12) +
  geom_hline(yintercept = mean(temp_raw$avgT_C), linetype="dotted") + #mean(temp_raw$avgT_C)
  #scale_color_continuous("PuBuGn") +
  labs(x="Month",y="T-avg"~(degree*C), subtitle = expression('Ambient Temperature'), colour="year") +  
  scale_color_manual(values = colorsXyear, name="Year") +
  # geom_vline(xintercept = 5.9, colour="lightgray") +
  # geom_vline(xintercept = 9.9, colour="lightgray") +
   geom_hline(yintercept = mean(annual$temp_avg), linetype="dotted")
plot_temp_month   

range(temp_raw$maxT_C)
plot_tempmax_month <-  temp_raw %>%
  filter(year>2008) %>%
  ggplot(aes(x=month, y=maxT_C, group=as.factor(year), colour=as.factor(year))) +   geom_rect( aes( xmin = 5.9,  xmax = 9.9,
      ymin = 0, ymax =35),
    fill = alpha("lightgrey", 0.2), color="lightgrey") +
  geom_line() +   geom_point() +
  theme_classic() +
  #facet_wrap(~year) +
  #scale_y_continuous(limits=c(0, 25)) +
  scale_x_continuous(limits=c(1,12), breaks = 1:12) +
  geom_hline(yintercept = mean(temp_raw$maxT_C), linetype="dotted") + #mean(temp_raw$avgT_C)
  #scale_color_continuous("PuBuGn") +
  labs(x="Month", y="T max"~(degree*C), subtitle ="Max Temperature", colour="year") +  
  scale_color_manual(values = colorsXyear, name="Year") 
  # geom_vline(xintercept = 5.9, colour="lightgray") +
  # geom_vline(xintercept = 9.9, colour="lightgray")
plot_tempmax_month 

range(temp_raw$precipitation_mm, na.rm = T)

plot_rain_month <-  temp_raw %>%
  filter(year>2008) %>%
  ggplot( aes(x=month, y=precipitation_mm, group=as.factor(year), colour=as.factor(year))) +
    geom_rect( aes( xmin = 5.9,  xmax = 9.9,
      ymin = 0, ymax =100),
    fill = alpha("lightgrey", 0.2), color="lightgrey") +
  geom_line() +   geom_point() +
  theme_classic() +
  #facet_wrap(~year) +
  labs(x="Month", y="P (mm)", subtitle ="Precipitation", colour="year") +
  geom_hline(yintercept = mean(temp_raw$precipitation_mm, na.rm = T), linetype="dotted") + # mean of the total amount of yearly rainfall from he study period
  scale_x_continuous(limits=c(1,12), breaks = 1:12) +
  scale_y_continuous(limits=c(0, 100)) +
  scale_color_manual(values = colorsXyear, name="Year") 
  #facet_wrap(~year) +
  # geom_vline(xintercept = 5.9, colour="lightgray") +
  # geom_vline(xintercept = 9.9, colour="lightgray")
plot_rain_month


```
##compare long-term vs study period
```{r}
covars <- read.csv("./data/covariates_select_scaled_v5_exclude-temp-max.csv") %>% 
  filter(year2!=2020)

covars$season2 <- factor(covars$season2, levels = c("wet", "dry") )

covarssum <- covars %>% 
  dplyr::group_by(year2, season2) %>% 
  summarize(min=min(rain_sum),
            max=max(rain_sum))

ggplot(covars, aes(x=year2, y=rain_sum)) +
         geom_point() +
         facet_grid(~season)

obsmean_rain_sum <- mean(covars$rain_sum)
obssd_rain_sum <- sd(covars$rain_sum)

obsmean_rain_cv_lag <- mean(covars$rain_cv_lag)
obssd_rain_cv_lag <- sd(covars$rain_cv_lag)

# environemntal covars
temp_raw <- read.csv("./data/monthly_data_Pudahuel.csv") %>% 
  filter(year!="2020")
temp_raw$precipitation_mm[temp_raw$precipitation_mm==-999.0] <- NA

2019-1976



annual <- temp_raw %>%
  dplyr::group_by(year) %>%
  dplyr::summarize(temp_avg=mean(avgT_C), 
            temp_mMax=mean(maxT_C),
            rain_mm=sum(precipitation_mm, na.rm = T))

rainavg43years <- mean(annual$rain_mm, na.rm = T)
round(rainavg43years)

study <- temp_raw %>%
  filter(year>2008) %>% 
  dplyr::group_by(year) %>%
  dplyr::summarize(temp_avg=mean(avgT_C), 
            temp_mMax=mean(maxT_C),
            rain_mm=sum(precipitation_mm, na.rm = T))
rainavg12years <- round(mean(study$rain_mm, na.rm=T))
```
The long-term yearly average of cumulative amount of rainfall between 1976 and 2019 was 247 mm. The rainfall that fell between 2009 and 2019 that correspond to our data set was 153 mm. 

## select weather variables
```{r}
head(temp_raw)

nonbreeding <- c(1, 2, 3,4, 5, 10, 11, 12) #oct-march
breeding <- c(6:9) #april-sept

seasonkey_month$year<- as.integer(seasonkey_month$year)


temp <- seasonkey_month %>% 
  filter(year!="2021") %>% 
  left_join(temp_raw) %>%
  dplyr::group_by(season, window, seasonkey, seasonid) %>%
 # arrange( year, season) %>%
  dplyr::summarise(temp_avg=mean(avgT_C, na.rm = T),
            temp_cv=sd(avgT_C, na.rm = T) / mean(avgT_C, na.rm = T), 
            temp_max=max(maxT_C, na.rm = T),
            rain_sum=sum(precipitation_mm, na.rm = T), 
            rain_cv=sd(precipitation_mm, na.rm = T)/mean(precipitation_mm, na.rm = T)) %>%
  dplyr::arrange(seasonkey) %>% 
  ungroup() 


temp$rain_cv[is.na(temp$rain_cv)]<-0



```

## lagged weather

Select appropriate weather variables for each season (lagged etc)


1.	rainfall data from Jun-Sept year n to predict survival/recruitment in June-Sept year n+1
2.	rainfall data from Oct-May year n to predict survival/recruitment June-Sept year n
It depends on how much effect we think rainfall will have: does the rainfall from a year ago influ-ence current food availability or is it more of an immediate effect, where rainfall in April/May in-fluence food availability? And I'm not sure which one to choose. 
This question arose because we changed the seasons for which we combined the environmental covariates from Apr-Sept to Jun-Sep, which meant there is a bit more rainfall during the Oct-May interval. In my email from last week, I attached an image of the sum of monthly rainfall across the 2009-2020 interval. 

Answer from Praveena: The impact of rainfall on vegetation depends on the type of vegetation.  If it's herbaceous plants (important for Degus), the effect is immediate, but plants with larger roots or trees can have a noticeable lag effect , which I guess is not much important to Degus. I think we should give more preference to the immediate growing season than the previous years or next years. Severe drought can definitely affect plant  density, leaf area next year due to impact on its growth in the first year affecting seed pool or bud formation for the next year.

Answer from Loren: The long-term effect may depend on how cumulative rainfall if the seed base depends on this. If it is impossible to include multiple periods, then I suggest going with the immediate effect. We might need a more in depth understanding of the long=term effects of rainfall on seed germina-tion, plant growth, etc.


```{r}

glimpse(temp)

weatherlag <- temp %>% 
  mutate( # focus on immediate effects
          rain_sum_lag=if_else(season=="breeding", lag(rain_sum, 1), lag(rain_sum, 1)),
          rain_cv_lag=if_else(season=="breeding", lag(rain_cv, 1), lag(rain_cv, 1)) ) # ,
    
    # for lag rain, breeding season is former wet season, dry season is former wet season
          # rain_sum_lag2=if_else(season=="breeding", lag(rain_sum, 2), lag(rain_sum, 1)),
          # rain_cv_lag2=if_else(season=="breeding", lag(rain_cv, 2), lag(rain_cv, 1))) 


```



# Environmental covariates

##study period
```{r}
modis_study <- modis_month %>% 
  filter(year %in% years)


```


## LAI: Leaf Area Index

```{r}
glimpse(modis_day)

  # plots
plot_lai_month <-  modis_study %>%
  ggplot( aes(x=month, y=LAI_avg, group=as.factor(year), colour=as.factor(year))) +
      geom_rect( aes( xmin = 5.9,  xmax = 9.9,
      ymin = 0, ymax =3),
    fill = alpha("lightgrey", 0.2), color="lightgrey") +
  geom_line() +   geom_point( )+
  theme_classic() +
  scale_color_manual(values = colorsXyear, name="Year") +
  #facet_wrap(~year) +
  labs(x="Month", y=expression(LAI-avg~(m^2)), subtitle ="Leaf Area Index", colour="year") +
  geom_hline(yintercept = mean(modis_study$LAI_avg, na.rm=T), linetype="dotted") +
  scale_x_continuous(limits=c(1,12), breaks = 1:12) +
  scale_y_continuous(limits=c(0, 3)) #max(modis_study$LAI_avg)
 
  #geom_segment(x = 6, xend=9.9, y =6, yend=5.6, colour="lightgray", alpha=0.7)
plot_lai_month


```




## ET: Evapotranspiration

```{r}
max(modis_study$ET_sum)

plot_et_sum <-  modis_study %>%
  ggplot( aes(x=month, y=ET_sum, group=as.factor(year), colour=as.factor(year))) +
   geom_rect( aes( xmin = 5.9,  xmax = 9.9,
      ymin = 0, ymax =71),
    fill = alpha("lightgrey", 0.2), color="lightgrey") +
    geom_line() +   geom_point() +
  scale_color_manual(values = colorsXyear, name="Year") +
  theme_classic() +
  #facet_wrap(~year) +
  labs(x="Month", y="ET (mm)", subtitle ="Evapotranspiration", colour="year") +
  geom_hline(yintercept = mean(modis_study$ET_sum), linetype="dotted") +
  scale_x_continuous(limits=c(1,12), breaks = 1:12) #+
  # geom_vline(xintercept = 5.9, colour="lightgray") +
  # geom_vline(xintercept = 9.9, colour="lightgray")
plot_et_sum

max(modis_study$ET_avg)

  plot_et_avg <-  modis_study %>%
   ggplot( aes(x=month, y=ET_avg, group=as.factor(year), colour=as.factor(year))) +
   geom_rect( aes( xmin = 5.9,  xmax = 9.9,
      ymin = 0, ymax =3),
    fill = alpha("lightgrey", 0.2), color="lightgrey") +
  scale_color_manual(values = colorsXyear, name="Year") +
  geom_line() +   geom_point() +
  #scale_color_manual(values = colors) +
  theme_classic() +
  #facet_wrap(~year) +
  labs(x="Month", y="ET-avg (mm)", subtitle ="Evapotranspiration", colour="year") +
  geom_hline(yintercept = mean(modis_study$ET_avg), linetype="dotted") +
  scale_x_continuous(limits=c(1,12), breaks = 1:12) +
  geom_vline(xintercept = 5.9, colour="lightgray") +
  geom_vline(xintercept = 9.9, colour="lightgray")
plot_et_avg

ggarrange(plot_et_avg, plot_et_sum)
```
## GPP: Gross Primary Production

```{r}
max(modis_study$GPP_sum)

plot_gpp_sum <-   ggplot( modis_study, 
                          aes(x=month, y=GPP_sum, group=as.factor(year), colour=as.factor(year))) +
    geom_rect( aes( xmin = 5.9,  xmax = 9.9,
      ymin = 0, ymax =150),
    fill = alpha("lightgrey", 0.2), color="lightgrey") +
  geom_line() +   geom_point() +
  theme_classic() +
  scale_color_manual(values = colorsXyear, name="Year") +
  #facet_wrap(~year) +
  labs(x="Month", y=expression(GPP~(gCm^2)), subtitle ="Gross Primary Production", colour="year") +
  geom_hline(yintercept = mean(modis_study$GPP_sum), linetype="dotted") +
  scale_x_continuous(limits=c(1,12), breaks = 1:12) 
  # geom_vline(xintercept = 5.9, colour="lightgray") +
  # geom_vline(xintercept = 9.9, colour="lightgray")
plot_gpp_sum

plot_gpp_avg<-  ggplot( modis_study, 
                          aes(x=month, y=GPP_avg, group=as.factor(year), colour=as.factor(year))) +
  geom_line() +   geom_point() +
  theme_classic() +
  scale_color_manual(values = colors) +
  #facet_wrap(~year) +
  labs(x="Month", y=expression("GPP avg"~(gCm^2)), subtitle ="Gross Primary Production", colour="year") +
  geom_hline(yintercept = mean(modis_study$GPP_avg), linetype="dotted") +
  scale_x_continuous(limits=c(1,12), breaks = 1:12) 
  # geom_vline(xintercept = 5.9, colour="lightgray") +
  # geom_vline(xintercept = 9.9, colour="lightgray")
plot_gpp_avg

ggarrange(plot_gpp_sum, plot_gpp_avg)

```



## ONI
El Niño-Southern Oscillation
Regional temperature and precipitation oscillations caused by El Nino. “El Niño conditions occur when the average sea-surface temperature of three consecutive months is 0.5°C above average temperature and La Niña conditions occur when the average sea-surface temperature is 0.5°C below average temperature. We obtained the ONI value from the National Oceanographic and Atmospheric Agency Climate Prediction Center” https://origin.cpc.ncep.noaa.gov/products/analysis_monitoring/ensostuff/ONI_v5.php 

```{r}

# did it in excel instead, see
oni<- seasonkey_month %>%
  left_join(enso_raw, by=c("year", "month")) %>%
  dplyr::filter(oni!="NA") %>% 
  dplyr::group_by(season, window, seasonkey, seasonid) %>%
  dplyr::summarize(oni_avg=mean(oni)) %>% 
  dplyr::arrange(seasonkey) 

range(enso_raw$oni)

plot_oni_month <-  enso_raw %>%
  filter(year%in%years) %>% 
  group_by(year, month) %>%
  #summarize(mean_oni=mean(oni)) %>% 
  #filter(year>2016) %
  ggplot( aes(x=month, y=oni, group=as.factor(year), colour=as.factor(year))) +
    geom_rect( aes( xmin = 5.9,  xmax = 9.9,
      ymin = -2, ymax =3),
    fill = alpha("lightgrey", 0.2), color="lightgrey") +
  geom_line() +   geom_point() +
  theme_classic() +
  scale_color_manual(values = colorsXyear, name="Year") +
  #facet_wrap(~year) +
  labs(x="Month", y="ONI", subtitle ="El Niño Index", colour="year") +
  geom_hline(yintercept = mean(enso_raw$oni), linetype="dotted") +
  scale_x_continuous(limits=c(1,12), breaks = 1:12) 
  #scale_y_continuous(limits=c(0, 0.05)) +
  # geom_vline(xintercept = 5.9, colour="lightgray") +
  # geom_vline(xintercept = 9.9, colour="lightgray")
plot_oni_month

```


# Plots Study Period Monthly

```{r}
plot_month_all <- ggpubr::ggarrange(plot_temp_month + rremove("xlab"), 
                                    plot_lai_month+ rremove("xlab"), 
                                    plot_rain_month+ rremove("xlab"),  
                                    plot_et_sum+ rremove("xlab"),
                                    plot_tempmax_month+ rremove("xlab"), 
                                    plot_gpp_sum, plot_oni_month,
                         nrow=4, ncol=2, align = "v",
                         common.legend = TRUE, legend = "bottom")
plot_month_all

ggsave( "results/environmental covars X month_allv4.pdf", width = 180, height = 200, units = "mm", dpi=300)
```





# Plots long-term covariates

https://davidmathlogic.com/colorblind/#%23D81B60-%231E88E5-%23FFC107-%23004D40 
```{r annual}
head(temp_raw)
temp_raw$precipitation_mm[temp_raw$precipitation_mm==-999.0] <- NA

annual <- temp_raw %>%
  dplyr::group_by(year) %>%
  dplyr::summarize(temp_avg=round(mean(avgT_C), 2), 
            temp_max=round(max(maxT_C, na.rm = T), 2),
            #temp_cv=formatC(sd(avgT_C, na.rm = T) / mean(avgT_C, na.rm = T),format = "f", flag="0"),
            temp_cv=round(sd(avgT_C, na.rm = T) / mean(avgT_C, na.rm = T),3),
            rain_mm=sum(precipitation_mm, na.rm = T),
            rain_cv=round(sd(precipitation_mm, na.rm = T)/mean(precipitation_mm, na.rm = T), 3))

plot_temp_year <- ggplot(annual, aes(x=year, y=temp_avg)) +
  geom_line(colour="#fd8d3c") +  
  geom_point(fill="#fd8d3c", shape = 21, color="black",  size=2 ) +
  theme_classic() +
  labs(x="Year", y=expression('T avg'~(degree*C)), subtitle ='Ambient Temperature')+
  geom_hline(yintercept = mean(annual$temp_avg), linetype="dotted")
plot_temp_year

plot_temp_cv_year <- ggplot(annual, aes(x=year, y=temp_cv)) +
  geom_line(colour="#fed976") +   
  geom_point(fill="#fed976", shape = 21, color="black",  size=2 ) +
  theme_classic() +
  labs(x="Year", y="T CV", subtitle = "CV Temperature")+
  geom_hline(yintercept = mean(annual$temp_cv), linetype="dotted")
plot_temp_cv_year

plot_temp_max_year <- ggplot(annual, aes(x=year, y=temp_max)) +
  geom_line(colour="#f03b20") +   
  geom_point(fill="#f03b20", shape = 21, color="black",  size=2 ) +
  theme_classic() +
  labs(x="Year",  y=expression('T max'~(degree*C)), subtitle ="Max Temperature")+
  geom_hline(yintercept = mean(annual$temp_max), linetype="dotted")
plot_temp_max_year

plot_rain_year <- ggplot(annual, aes(x=year, y=rain_mm)) +
  geom_line(color="#1E88E5") +  
  geom_point(fill="#1E88E5", shape = 21, color="black",  size=2 ) +
  theme_classic() +
  labs(x="Year", y="P (mm)", subtitle =  "Precipitation") +
  geom_hline(yintercept = mean(annual$rain_mm), linetype="dotted") +
  scale_y_continuous(limits=c(0, 700))
plot_rain_year

range(annual$rain_cv)
plot_raincv_year <- ggplot(annual, aes(x=year, y=rain_cv)) +
  geom_line(color="#9ecae1") +  
  geom_point(fill="#9ecae1", shape = 21, color="black",  size=2 ) +
  theme_classic() +
  labs(x="Year", y="P CV", subtitle =  "CV Precipitation") +
  geom_hline(yintercept = mean(annual$rain_cv), linetype="dotted") +
  scale_y_continuous(limits=c(0, 2.5))
plot_raincv_year

plot_lai_year <- modis_day %>%
  dplyr::group_by(year) %>%
  dplyr::summarize(lai_avg=mean(LAI)) %>% 
  ggplot( aes(x=year, y=lai_avg)) +
  geom_line(color="#a1d99b") +  
  geom_point(fill="#a1d99b", shape = 21, color="black",  size=2 ) +
  theme_classic() +
  labs(x="Year", y=expression("LAI"~(m^2)), subtitle =  "Leaf Area Index") +
  geom_hline(yintercept = mean(modis_day$LAI), linetype="dotted") +
  #scale_y_continuous(limits=c(0, 0.5)) +
  scale_x_continuous(limits=c(2000, 2020))
plot_lai_year 

plot_gpp_year <- modis_day %>%
  dplyr::group_by(year) %>%
  dplyr::summarize(gpp_avg=mean(GPP)) %>% 
  ggplot( aes(x=year, y=gpp_avg)) +
  geom_line(color="#006d2c") +  
  geom_point(fill="#006d2c", shape = 21, color="black",  size=2 ) +
  theme_classic() +
  labs(x="Year", y=expression('GPP'~(gCm^2)), subtitle="Gross Primary Production") +
  geom_hline(yintercept = mean(modis_day$GPP), linetype="dotted") +
  #scale_y_continuous(limits=c(0, 0.5)) +
  scale_x_continuous(limits=c(2000, 2020))
plot_gpp_year 

plot_et_year <- modis_day %>%
  dplyr::group_by(year) %>%
  dplyr::summarize(et_avg=mean(ET)) %>% 
  ggplot( aes(x=year, y=et_avg)) +
  geom_line(color="#D81B60") +  
  geom_point(shape = 21, color="black", fill="#D81B60", size=2) +
  theme_classic() +
  labs(x="Year", y="ET (mm)",subtitle ="Evapotranspiration") +
  geom_hline(yintercept = mean(modis_day$ET), linetype="dotted") +
  #scale_y_continuous(limits=c(0, 0.5)) +
  scale_x_continuous(limits=c(2000, 2020))
plot_et_year 


plot_oni_year <- enso_raw %>%
  dplyr::group_by(year) %>%
  dplyr::summarize(oni_avg=mean(oni)) %>% 
  ggplot( aes(x=year, y=oni_avg)) +
  geom_line(color="#bdbdbd") +  
  geom_point( shape = 21, color="black", fill="#bdbdbd", size=2 ) +
  theme_classic() +
  labs(x="Year", y= "ONI", subtitle="El Niño index") +
  geom_hline(yintercept = mean(enso_raw$oni, na.rm=T), linetype="dotted") +
  #scale_y_continuous(limits=c(0, 0.5)) +
  scale_x_continuous(limits=c(2000, 2020)) +
  
plot_oni_year

```


```{r}

ggarrange(plot_temp_year, plot_lai_year, 
          plot_temp_max_year, plot_gpp_year,
          plot_temp_cv_year, plot_et_year,
          plot_rain_year, plot_oni_year,
          plot_raincv_year, 
          nrow=5, ncol=2, 
          align="hv", widths = c(1.5,1))

ggsave("./results/longterm_envir-covars_v10.pdf", width = 180, height=240, units = "mm", dpi=300)

```





# Select Covariates


## combine all covars
```{r}
# By day
modis_day$year <- as.factor(modis_day$year)

modis <- seasonkey_month %>%
  left_join(modis_day) 

## join to weather variables
modisXseason <- modis %>%
  dplyr::group_by(season, seasonkey, seasonid) %>%
    dplyr::summarize(gpp_avg=mean(GPP, na.rm = T), 
            gpp_sum = sum(GPP, na.rm = T),
            et_avg=mean(ET, na.rm=T),
            et_sum = sum(ET, na.rm = T),
            lai_avg = mean(LAI, na.rm=T)) %>% 
  dplyr::arrange(seasonkey)



# by month
modis_month$year<- as.factor(modis_month$year)
modism <- seasonkey_month %>%
  left_join(modis_month) 

## join to weather variables
modismXseason <- modism %>%
  dplyr::group_by(season, seasonkey, seasonid) %>%
    dplyr::summarize(gpp_avg=mean(GPP_avg, na.rm = T), 
            gpp_sum = sum(GPP_sum, na.rm = T),
            et_avg=mean(ET_avg, na.rm=T),
            et_sum = sum(ET_sum, na.rm = T),
            lai_avg = mean(LAI_avg, na.rm=T)) %>% 
  arrange(seasonkey)




# combine all weather variables
weather_modis <- weatherlag %>% 
  left_join(modisXseason, by = c( "seasonkey", "season", "seasonid")) %>% 
  left_join(oni) %>% 
  filter(seasonkey>0)
glimpse(weather_modis)


write.csv(weather_modis, "data/all environmental covariates_20250225.csv")

```


## check with Praveena's calculations

what did Praveena do for the nonbreeding season (only those values don't add up)
 I calculated by month and daily values, and everytime I get the same.
 then i checked her excel files and get the same values as that i got from R. 
 so where does praveena get her nonbreeding values from?
 
 I think she averaged her average values from ond from one year and the jfmam from the other, instead of averaging over daily values.  


```{r}
# from Praveena
modisXseason_pk <- read.csv("data/MODIS_year_season.csv")

check.modis <- full_join(modisXseason, modisXseason_pk, by=c("season", "seasonkey")) # nonbreeding doesn't correspond

check.modism <- full_join(modismXseason, modisXseason_pk, by=c("season", "seasonkey"))


modis_pk <- read.csv("data/MODIS_year_season_data_PK.csv")

check_pk <- modis_pk %>% 
  summarise(mean)

N09etsum <- sum(65.3+58.8)
N09gppavg <- (2.5952+1.4366)/2

65.3+58.8


# how different from used covariates fiel?
covars_old <- read.csv("data/covariates_final.csv")



```



Pairwise correlations
http://www.sthda.com/english/wiki/correlation-matrix-a-quick-start-guide-to-analyze-format-and-visualize-a-correlation-matrix-using-r-software

my general rule is to not use variables with r>=0.5.



## select sum GPP and ET as we also have sum P

```{r}
covariates <- weather_modis %>% 
  dplyr::select(-gpp_avg, -et_avg)

# select variables to include in correlation matrix
df <- covariates[, 5:15]

#create matrix
res <- round(cor(df),2)
write.csv(res, "./results/covariate correlation_v10.csv")


# visalise matrix
pairs(df)
psych::pairs.panels(df) # Generate scatterplots with Pearson correlations

jpeg(file="./results/correlation matrix_v10.jpeg")
corrplot::corrplot(round(cor(df),2), type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
dev.off()

#PerformanceAnalytics::chart.Correlation(my_data, histogram=TRUE, pch=19)

#library(Hmisc)
#res2<-Hmisc::rcorr(as.matrix(covariates[,5:15]))

#corrplot::corrplot(res2$r, type="upper", order="hclust", 
#         p.mat = res2$P, sig.level = 0.01, insig = "blank")


```

### R

 We have to exclude max temperature as it still has r2>0.5 with rain_sumlag and rain_cv_lag.  

```{r}

# select variables to include in correlation matrix
select_covariates<- covariates %>%
  #dplyr::select(-temp_avg) # still ones with r > 0.5
  #dplyr::select(-temp_avg,  -temp_max) # 
  #dplyr::select(-temp_avg,  -rain_sum_lag, - temp_max) # Tmax r>0.5 with 3 other variables
  dplyr::select(-temp_avg,  -rain_sum_lag, - temp_max, -et_sum) # Tmax r>0.5 with 3 other variables

dfs <- select_covariates[,5:11]
ress <- round(cor(dfs),2)
psych::pairs.panels(df1) # Generate scatterplots with Pearson correlations



```

If we use sum, then remove Temp_avg, temp_max, rain_sum_lag, and et_sum


###VIF
Exclude variables with VIF values > 3 or >10? 



```{r}
# vif
Z <- cbind( covariates$temp_avg, 
            covariates$temp_cv,
            covariates$temp_max,
            covariates$rain_sum,
            covariates$rain_sum_lag, 
            covariates$rain_cv,
            covariates$rain_cv_lag, 
            covariates$lai_avg, 
            covariates$et_sum, 
            covariates$gpp_sum,
            covariates$oni_avg)
colnames(Z) <- c( "T", "Tcv","Tmax", "P","Plag", "Pcv","Pcvl", "lai",  "et","gpp", "oni")
dfz = data.frame(Z) # Data Frame with predictor variables
usdm::vif(dfz) # VIF > 10: T


# Relationships between explanatory variables.
Z <- cbind( #covariates$temp_avg, 
            covariates$temp_cv,
            covariates$temp_max,
            covariates$rain_sum,
            covariates$rain_sum_lag, 
            covariates$rain_cv,
            covariates$rain_cv_lag, 
            covariates$lai_avg, 
            covariates$et_sum, 
            covariates$gpp_sum,
            covariates$oni_avg)
colnames(Z) <- c(  "Tcv","Tmax", "rain","rainlag", "raincv","raincvl", "lai",  "et","gpp", "oni")
dfz = data.frame(Z) # Data Frame with predictor variables
usdm::vif(dfz) # VIF > 10: et


# Relationships between explanatory variables.
Z <- cbind( #covariates$temp_avg, 
            covariates$temp_cv,
            covariates$temp_max,
            covariates$rain_sum,
            covariates$rain_sum_lag, 
            covariates$rain_cv,
            covariates$rain_cv_lag, 
            covariates$lai_avg, 
            #covariates$et_avg, 
            covariates$gpp_sum,
            covariates$oni_avg)
colnames(Z) <- c(  "Tcv","Tmax", "rain","rainlag", "raincv","raincvl", "lai",  "gpp", "oni")
dfz = data.frame(Z) # Data Frame with predictor variables
usdm::vif(dfz) # VIF > 10: tmax

Z <- cbind( #covariates$temp_avg, 
            covariates$temp_cv,
            #covariates$temp_max,
            covariates$rain_sum,
            covariates$rain_sum_lag, 
            covariates$rain_cv,
            covariates$rain_cv_lag, 
            covariates$lai_avg, 
            #covariates$et_avg, 
            covariates$gpp_sum,
            covariates$oni_avg)
colnames(Z) <- c(  "Tcv", "rain","rainlag", "raincv","raincvl","lai", "gpp", "oni")
dfz = data.frame(Z) # Data Frame with predictor variables
usdm::vif(dfz) # VIF > 10: 


# varaibales all with vif<3, exclude temp_avg, tempmax, et_sum,


```

## select avg GPP and ET so not to change to much 

```{r}
covariates <- weather_modis %>% 
  dplyr::select(-gpp_sum, -et_sum)

# select variables to include in correlation matrix
df <- covariates[, 5:15]

#create matrix
res <- round(cor(df),2)
write.csv(res, "./results/covariate correlation_v10.csv")


# visalise matrix
pairs(df)
psych::pairs.panels(df) # Generate scatterplots with Pearson correlations

jpeg(file="./results/correlation matrix_v10.jpeg")
corrplot::corrplot(round(cor(df),2), type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
dev.off()

#PerformanceAnalytics::chart.Correlation(my_data, histogram=TRUE, pch=19)

#library(Hmisc)
#res2<-Hmisc::rcorr(as.matrix(covariates[,5:15]))

#corrplot::corrplot(res2$r, type="upper", order="hclust", 
#         p.mat = res2$P, sig.level = 0.01, insig = "blank")


```
### R

 We have to exclude max temperature as it still has r2>0.5 with rain_sumlag and rain_cv_lag.  

```{r}

# select variables to include in correlation matrix
select_covariates<- covariates %>%
  #dplyr::select(-temp_avg) # still ones with r > 0.5
  #dplyr::select(-temp_avg,  -et_avg) # 
  #dplyr::select(-temp_avg,  -et_avg, - lai_avg) # Tmax r>0.5 with 3 other variables
  dplyr::select(-temp_avg,-temp_max,  -et_avg, - lai_avg) # Tmax r>0.5 with 3 other variables

df1 <- select_covariates[,5:11]
res1 <- round(cor(df1),2)
psych::pairs.panels(df1) # Generate scatterplots with Pearson correlations



```


### VIF
```{r}
# vif
Z <- cbind( covariates$temp_avg, 
            covariates$temp_cv,
            covariates$temp_max,
            covariates$rain_sum,
            covariates$rain_sum_lag, 
            covariates$rain_cv,
            covariates$rain_cv_lag, 
            covariates$lai_avg, 
            covariates$et_avg, 
            covariates$gpp_avg,
            covariates$oni_avg)
colnames(Z) <- c( "T", "Tcv","Tmax", "rain","rainlag", "raincv","raincvl", "lai",  "et","gpp", "oni")
dfz = data.frame(Z) # Data Frame with predictor variables
usdm::vif(dfz) # VIF > 10: T


# Relationships between explanatory variables.
Z <- cbind( #covariates$temp_avg, 
            covariates$temp_cv,
            covariates$temp_max,
            covariates$rain_sum,
            covariates$rain_sum_lag, 
            covariates$rain_cv,
            covariates$rain_cv_lag, 
            covariates$lai_avg, 
            covariates$et_avg, 
            covariates$gpp_avg,
            covariates$oni_avg)
colnames(Z) <- c(  "Tcv","Tmax", "rain","rainlag", "raincv","raincvl", "lai",  "et","gpp", "oni")
dfz = data.frame(Z) # Data Frame with predictor variables
usdm::vif(dfz) # VIF > 10: et


# Relationships between explanatory variables.
Z <- cbind( #covariates$temp_avg, 
            covariates$temp_cv,
            covariates$temp_max,
            covariates$rain_sum,
            covariates$rain_sum_lag, 
            covariates$rain_cv,
            covariates$rain_cv_lag, 
            covariates$lai_avg, 
            #covariates$et_avg, 
            covariates$gpp_avg,
            covariates$oni_avg)
colnames(Z) <- c(  "Tcv","Tmax", "rain","rainlag", "raincv","raincvl", "lai",  "gpp", "oni")
dfz = data.frame(Z) # Data Frame with predictor variables
usdm::vif(dfz) # VIF > 10: lai

Z <- cbind( #covariates$temp_avg, 
            covariates$temp_cv,
            covariates$temp_max,
            covariates$rain_sum,
            covariates$rain_sum_lag, 
            covariates$rain_cv,
            covariates$rain_cv_lag, 
            #covariates$lai_avg, 
            #covariates$et_avg, 
            covariates$gpp_avg,
            covariates$oni_avg)
colnames(Z) <- c(  "Tcv","Tmax", "rain","rainlag", "raincv","raincvl", "gpp", "oni")
dfz = data.frame(Z) # Data Frame with predictor variables
usdm::vif(dfz) # VIF > 10: 


# varaibales all with vif<3, exclude temp_avg, et_avg, lai_avg

```









# standardize and save select covariates

If we use sum, then remove Temp_avg, temp_max, rain_sum_lag, and et_sum

```{r}
#center on mean and scale on SD
# scale_covariates_sum <- select_covariates %>% 
#   mutate(temp_cv2=scale(temp_cv), 
#          rain_sum2=scale(rain_sum),
#          rain_cv2=scale(rain_cv),
#          gpp_sum2=scale(gpp_sum),
#          lai_avg2=scale(lai_avg),
#          oni_avg2=scale(oni_avg),
#          rain_cv_lag2=scale(rain_cv_lag), 
#          season2=if_else(season=="breeding", "wet", "dry")
#         ) %>% 
#   separate(seasonid, into = c("season1", "window1", "year2"), remove = F) %>% 
#   select(seasonkey, seasonid, season, season1, season2, window, year2, everything(), -window1)
# 
# 
# write.csv(scale_covariates_sum, "./data/covariates_select_scaled_v10_sum.csv")

```

If we use avg then remove -temp_avg,-temp_max,  -et_avg, - lai_avg

```{r}
#center on mean and scale on SD
scale_covariates_avg <- select_covariates %>% 
  mutate(temp_cv2=scale(temp_cv), 
         rain_sum2=scale(rain_sum),
         rain_cv2=scale(rain_cv),
         gpp_avg2=scale(gpp_avg),
         oni_avg2=scale(oni_avg),
         rain_sum_lag2=scale(rain_sum_lag), 
         rain_cv_lag2=scale(rain_cv_lag), 
         season2=if_else(season=="breeding", "wet", "dry")
        ) %>% 
  separate(seasonid, into = c("season1", "window1", "year2"), sep="_", remove = FALSE) %>% 
  select(seasonkey, seasonid, season, season1, season2, window, year2, everything(), -window1)


write.csv(scale_covariates_avg, "./data/covariates_select_scaled_v10_avg.csv")

```




# Plots select environmental covariatesXmonthXyear

```{r}
covariates <- read.csv("data/all environmental covariates_20250225.csv") %>% 
  separate(seasonid, into = c("season1", "window1", "year"), remove = FALSE)

covars_real$season <- factor(covars_real$season, 
                             levels = c("breeding", "nonbreeding"),
                             labels = c("B", "N"))
```


## compare Gpp 2019 to study period

```{r}
# total
summ_gpp <- covariates %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarize(mean=mean(gpp_sum))

totalgpp <- covariates %>%
  filter(year!=2019) %>% 
  #dplyr::group_by(year) %>% 
  dplyr::summarize(mean=mean(gpp_sum))
mean(covariates$gpp_sum)

summ_gpp_breed <- covariates %>% 
  dplyr::group_by(year, season) %>% 
  dplyr::summarize(mean=mean(gpp_sum))
mean(covariates$gpp_avg[covariates$season=="breeding"])

summ_gpp <- covariates %>% 
  filter(year!=2019) %>% 
  dplyr::group_by( season) %>% 
  dplyr::summarize(mean=mean(gpp_sum))

# average
avg_gpp <- covariates %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarize(mean=mean(gpp_avg))
mean(covariates$gpp_avg)

totalavggpp <- covariates %>%
  filter(year!=2019) %>% 
  #dplyr::group_by(year) %>% 
  dplyr::summarize(mean=mean(gpp_avg))

summ_gpp <- covariates %>% 
  filter(year==2019) %>% 
  dplyr::group_by(year, season) %>% 
  dplyr::summarize(mean=mean(gpp_avg))

summ_gpp <- covariates %>% 
  filter(year!=2019) %>% 
  dplyr::group_by( season) %>% 
  dplyr::summarize(mean=mean(gpp_avg))
mean(covariates$gpp_avg[covariates$season=="breeding"])
```

##plots highlight 2019

```{r}
colorsXyear <- paletteer::scale_colour_paletteer_d("rcartocolor::Safe")
colorsXyear <-paletteer::paletteer_d("rcartocolor::Safe")
```


```{r GPP}

plot_gpp_hl<-  ggplot( modis_study, 
                          aes(x=month, y=GPP_avg, group=as.factor(year), colour=as.factor(year))) +
  #   geom_rect( aes( xmin = 5.9,  xmax = 9.9, 
  #     ymin = 0, ymax = 5),
  #   fill = "lightgrey", color="lightgrey", alpha=0.2) +
  geom_line(size=1) +   geom_point(size=3) +
  scale_color_manual(values = colorsXyear) +
   gghighlight(year=="2019",
              # preserve colour and modify alpha instead
              unhighlighted_params = list(colour = NULL, alpha = 0.3, size=1))+
  theme_degu() +
  theme(legend.position="right") +
  #facet_wrap(~year) +
  labs(x="Month", y=expression("GPP avg"~(gCm^2)),  colour="year") + #subtitle ="Gross Primary Production",
  geom_hline(yintercept = mean(modis_study$GPP_avg), linetype="dotted") +
  scale_x_continuous(limits=c(1,12), breaks = 1:12) +
   geom_vline(xintercept = 5.9,  linetype="dashed", colour="gray") + #colour="lightgray",
  geom_vline(xintercept = 9.9, linetype="dashed", colour="gray")
plot_gpp_hl


```
 



```{r rain sum}
temp_study <- temp_raw %>% 
 filter(year %in% years)
temp_study$year <- as.factor(temp_study$year)


plot_rain_hl <-  temp_study %>%
  ggplot( aes(x=month, y=precipitation_mm, group=as.factor(year), colour=as.factor(year))) +
  geom_line(size=1) +   geom_point(size=3) +
  scale_color_manual(values=colorsXyear) +
  gghighlight(year=="2019", #label_key = year,
              # preserve colour and modify alpha instead
              unhighlighted_params = list(colour = NULL, alpha = 0.3, size=1))+
  scale_x_continuous(limits=c(1,12), breaks = 1:12) +
    scale_y_continuous(limits=c(0, 100)) +
  labs(x="Month", y="P (mm)", colour="year") +
  geom_hline(yintercept = mean(annual$rain_mm, na.rm=T), linetype="dotted") + # mean of the total amount of yearly rainfall from 1976-2020
  geom_hline(yintercept = mean(temp_study$precipitation_mm, na.rm=T), linetype="dotted") + # mean of the total amount of yearly rainfall from 1976-2020
  geom_vline(xintercept = 5.9,  linetype="dashed", colour="gray") + #colour="lightgray",
  geom_vline(xintercept = 9.9, linetype="dashed", colour="gray") + #colour="lightgray")
   # geom_text_repel(data = labels_df, aes(x=month, y=precipitation_mm, label = year), 
   #            nudge_x = 0.0, nudge_y = 0.001, size = 3, color = "black",
   #             max.overlaps = getOption("ggrepel.max.overlaps", default = 15)) +
   theme_degu() +
   theme(legend.position = "none")
plot_rain_hl
```



```{r oni}
enso_study <- enso_raw %>% 
   filter(year %in% years)

enso_study$year <- as.factor(enso_study$year)


plot_oni_hl <-  enso_study %>%
  ggplot( aes(x=month, y=oni, group=as.factor(year), colour=as.factor(year))) +
  geom_line(size=1) +   geom_point(size=3) +

  scale_color_manual(values=colorsXyear) +
  gghighlight(year=="2019", #label_key = year,
              # preserve colour and modify alpha instead
              unhighlighted_params = list(colour = NULL, alpha = 0.3, size=1))+
  scale_x_continuous(limits=c(1,12), breaks = 1:12) +
  
  labs(x="Month",  y ="ONI", colour="year") +
  
  geom_hline(yintercept = mean(enso_raw$oni), linetype="dotted") +
  geom_vline(xintercept = 5.9,  linetype="dashed", colour="gray") + #colour="lightgray",
  geom_vline(xintercept = 9.9, linetype="dashed", colour="gray") + #colour="lightgray")
   # geom_text_repel(data = labels_df, aes(x=month, y=oni, label = year), 
   #            nudge_x = 0.0, nudge_y = 0.001, size = 3, color = "black",
   #             max.overlaps = getOption("ggrepel.max.overlaps", default = 15)) +
   theme_degu() +
   theme(legend.position = "right")
plot_oni_hl

```

For cv we don't have daily values just monthly, so we have to use it by year

```{r temp_cv}

annual_study <- annual %>% 
  filter(year %in% 2009:2020)

annual_study$year <- as.factor(annual_study$year)


plot_tcv_hl <-  annual_study %>%
  ggplot( aes(x=year, y=temp_cv, group=as.factor(year), colour=as.factor(year), 
              fill=as.factor(year))) +
  geom_point( shape = 21, color="black",  size=4) +

    scale_fill_manual(values=colorsXyear) +

  scale_color_manual(values=colorsXyear) +
  gghighlight(year=="2019", #label_key = year,
              # preserve colour and modify alpha instead
              unhighlighted_params = list(colour = NULL,  size=2))+
  scale_x_continuous(limits=c(2009,2020), breaks=c(2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020) ) +
  
  labs(x="Year",  y ="T CV", colour="year") +
  
  geom_hline(yintercept = mean(annual$temp_cv), linetype="dotted") +
  geom_vline(xintercept = 5.9,  linetype="dashed", colour="gray") + #colour="lightgray",
  geom_vline(xintercept = 9.9, linetype="dashed", colour="gray") + #colour="lightgray")

   theme_degu() +
   theme(legend.position = "right")

plot_tcv_hl






```

```{r rain_cv}


range(annual$rain_cv)
plot_raincv_year <-   ggplot(annual_study, aes(x=year, y=rain_cv, group=year, 
              colour=ifelse(year == '2019', '2019', 'Other') ,
                fill=ifelse(year == '2019', '2019', 'Other'))) +
  
  geom_point( shape = 21, color="black",  size=2) +
  scale_color_manual(values = c('2019' = "#4B692DFF", 'Other' = alpha("#E1E1D2FF", 1))) +
  scale_fill_manual(values = c('2019' = "#4B692DFF", 'Other' = alpha("#E1E1D2FF", 1))) +
  #scale_y_continuous(limits=c(0, 2)) +
   geom_line( color="black") +  
  labs(x="Year", y="CV Rainfall")+
  theme_degu() +
   theme(legend.position = "none") +
  geom_hline(yintercept = mean(annual$rain_cv), linetype="dotted") 
  
plot_raincv_year

plot_raincv_hl <-  annual_study %>%
  ggplot( aes(x=year, y=rain_cv, group=as.factor(year), colour=as.factor(year), 
              fill=as.factor(year))) +
  geom_point( shape = 21, color="black",  size=4) +

    scale_fill_manual(values=colorsXyear) +

  scale_color_manual(values=colorsXyear) +
  gghighlight(year=="2019", #label_key = year,
              # preserve colour and modify alpha instead
              unhighlighted_params = list(colour = NULL,  size=2))+
  scale_x_continuous(limits=c(2009,2020), breaks=c(2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020) ) +
  
  labs(x="Year",  y ="P CV", colour="year") +
  
  geom_hline(yintercept = mean(annual$rain_cv), linetype="dotted") +
  geom_vline(xintercept = 5.9,  linetype="dashed", colour="gray") + #colour="lightgray",
  geom_vline(xintercept = 9.9, linetype="dashed", colour="gray") + #colour="lightgray")

   theme_degu() +
   theme(legend.position = "right")
 plot_raincv_hl
```


### combine plots
```{r}
ggarrange(plot_gpp_hl, plot_tcv_hl,
          plot_rain_hl,plot_raincv_hl,
          
          plot_oni_hl,
          
          nrow=3, ncol=2, align = "hv",
          common.legend = TRUE, legend = "right")

ggsave( "results/environmental covars monthXyear_v3.pdf",  width= 250, height=200, units="mm", dpi=300)

```





## plotsX season


```{r}
## temp cv 
plot_temp_sXy <- ggplot(covars_real , aes(x = season, y =temp_cv, group = season))+
  geom_col(aes(color=season, fill=season))+
  #geom_ribbon(aes(ymin = lcl, ymax = ucl, color=season2, fill=season2),  alpha = 0.3)+
  labs(x = "Season", y="CV temperature")+
  scale_fill_manual(values=c("#40B0A6", "#E1BE6A")) +
  scale_color_manual(values=c("#40B0A6", "#E1BE6A")) +
  #facet_grid(sex~season2)+
  facet_grid(~year)+
  theme_degu() +
  theme(#axis.text.x = element_blank(),
         legend.position="bottom",        
         legend.title = element_blank(),
         axis.text = element_text(size = 12),
         strip.background  = element_blank(),
         strip.text  = element_blank(),
         panel.grid.major = element_blank(),
         panel.border = element_blank(),
         #axis.ticks = element_blank(),
         panel.grid.minor.x=element_blank(),
         panel.grid.major.x=element_blank() )
plot_temp_sXy

plot_rainsum <- ggplot(covars_real , aes(x = season, y =rain_sum, group = season))+
  geom_col(aes(color=season, fill=season))+
  #geom_ribbon(aes(ymin = lcl, ymax = ucl, color=season2, fill=season2),  alpha = 0.3)+
  labs(x = "Season", y="Rainfall (mm)")+
  scale_fill_manual(values=c("#40B0A6", "#E1BE6A")) +
  scale_color_manual(values=c("#40B0A6", "#E1BE6A")) +
  #facet_grid(sex~season2)+
  facet_grid(~year)+
  theme_degu() +
  theme(#axis.text.x = element_blank(),
         legend.position="bottom",        
         legend.title = element_blank(),
         axis.text = element_text(size = 12),
         strip.background  = element_blank(), 
       strip.text  = element_blank(),
         panel.grid.major = element_blank(),
         panel.border = element_blank(),
         #axis.ticks = element_blank(),
         panel.grid.minor.x=element_blank(),
         panel.grid.major.x=element_blank() )
plot_rainsum

plot_rainlag <- ggplot(covars_real , aes(x = season, y =rain_sum_lag, group = season))+
  geom_col(aes(color=season, fill=season))+
  labs(x = "Season", y="Lag in rainfall (mm)")+
  scale_fill_manual(values=c("#40B0A6", "#E1BE6A")) +
  scale_color_manual(values=c("#40B0A6", "#E1BE6A")) +
  #facet_grid(sex~season2)+
  facet_grid(~year)+
  theme_degu() +
  theme(axis.text.x = element_blank(),
         legend.position="bottom",        
         legend.title = element_blank(),
         axis.text = element_text(size = 12),
         strip.background  = element_blank(),
         #strip.text  = element_blank(),
         panel.grid.major = element_blank(),
         panel.border = element_blank(),
         #axis.ticks = element_blank(),
         panel.grid.minor.x=element_blank(),
         panel.grid.major.x=element_blank() )
plot_rainlag

plot_raincv <- ggplot(covars_real , aes(x = season, y =rain_cv, group = season))+
  geom_col(aes(color=season, fill=season))+
  labs(x = "Season", y="CV rainfall")+
  scale_fill_manual(values=c("#40B0A6", "#E1BE6A")) +
  scale_color_manual(values=c("#40B0A6", "#E1BE6A")) +
  #facet_grid(sex~season2)+
  facet_grid(~year)+
  theme_degu() +
  theme(#axis.text.x =element_blank(),
         legend.position="bottom",        
         legend.title = element_blank(),
         axis.text = element_text(size = 12),
         strip.background  = element_blank(),
         strip.text  = element_blank(),
         panel.grid.major = element_blank(),
         panel.border = element_blank(),
         #axis.ticks = element_blank(),
         panel.grid.minor.x=element_blank(),
         panel.grid.major.x=element_blank() )
plot_raincv

plot_raincvlag <- ggplot(covars_real , aes(x = season, y =rain_cv_lag, group = season))+
  geom_col(aes(color=season, fill=season))+
  labs(x = "Season", y="", subtitle="lag in CV rainfall")+
  scale_fill_manual(values=c("#40B0A6", "#E1BE6A")) +
  scale_color_manual(values=c("#40B0A6", "#E1BE6A")) +
  #facet_grid(sex~season2)+
  facet_grid(~year)+
  theme_degu() +
  theme(#axis.text.x = element_blank(),
         legend.position="bottom",        
         legend.title = element_blank(),
         axis.text = element_text(size = 12),
         strip.background  = element_blank(),
         strip.text  = element_blank(),
         panel.grid.major = element_blank(),
         panel.border = element_blank(),
         #axis.ticks = element_blank(),
         panel.grid.minor.x=element_blank(),
         panel.grid.major.x=element_blank() )
plot_raincvlag

plot_gpp<- ggplot(covars_real , aes(x = season, y =gpp_avg, group = season))+
  geom_col(aes(color=season, fill=season))+
  labs(x = "Season", y="GPP (Kg C/m^2/8day)")+
  scale_fill_manual(values=c("#40B0A6", "#E1BE6A")) +
  scale_color_manual(values=c("#40B0A6", "#E1BE6A")) +
  #facet_grid(sex~season2)+
  facet_grid(~year)+
  theme_degu() +
  theme(#axis.text.x =element_blank(),
         legend.position="bottom",        
         legend.title = element_blank(),
         axis.text = element_text(size = 12),
         strip.background  = element_blank(),
         #strip.text  = element_blank(),
         panel.grid.major = element_blank(),
         panel.border = element_blank(),
         #axis.ticks = element_blank(),
         panel.grid.minor.x=element_blank(),
         panel.grid.major.x=element_blank() )
plot_gpp

plot_oni<- ggplot(covars_real , aes(x = season, y =oni_avg, group = season))+
  geom_col(aes(color=season, fill=season))+
  labs(x = "Season", y="El Niño index")+
  scale_fill_manual(values=c("#40B0A6", "#E1BE6A")) +
  scale_color_manual(values=c("#40B0A6", "#E1BE6A")) +
  #facet_grid(sex~season2)+
  facet_grid(~year)+
  theme_degu() +
  theme(#axis.text.x = element_blank(),
         legend.position="bottom",        
         legend.title = element_blank(),
         axis.text = element_text(size = 12),
         strip.background  = element_blank(),
         strip.text  = element_blank(),
         panel.grid.major = element_blank(),
         panel.border = element_blank(),
         #axis.ticks = element_blank(),
         panel.grid.minor.x=element_blank(),
         panel.grid.major.x=element_blank() )
plot_oni



```

```{r}
ggarrange(plot_gpp+rremove("xlab"), 
          #plot_raincvlag+rremove("xlab"), 
           plot_rainsum+rremove("xlab"), 
          plot_temp_sXy +rremove("xlab"), 
         plot_oni +rremove("xlab"),
          #plot_rainlag+rremove("xlab"),
          plot_raincv, 
          
          nrow=5, ncol=1, align = "hv",
          common.legend = TRUE, legend = "none")

ggsave( "results/environmental covars seasonXyear_v1.pdf", width = 180, height = 200, units = "mm", dpi=300)

```


```{r}
## factors excluded from models
plot_temp<- ggplot(covars_real , aes(x = season2, y =temp_avg, group = season))+
  geom_col(aes(color=season, fill=season))+
  labs(x = "Season", y="", subtitle="Temperature (C)")+
  scale_fill_manual(values=c("#40B0A6", "#E1BE6A")) +
  scale_color_manual(values=c("#40B0A6", "#E1BE6A")) +
  #facet_grid(sex~season2)+
  facet_grid(~year)+
  theme_degu() +
  theme(axis.text.x = element_blank,
         legend.position="bottom",        
         legend.title = element_blank(),
         #axis.text = element_text(size = 12),
         strip.background  = element_blank(),
         strip.text  = element_blank(),
         panel.grid.major = element_blank(),
         panel.border = element_blank(),
         #axis.ticks = element_blank(),
         panel.grid.minor.x=element_blank(),
         panel.grid.major.x=element_blank() )
plot_temp

plot_tempM<- ggplot(covars_real , aes(x = season2, y =temp_max, group = season))+
  geom_col(aes(color=season, fill=season))+
  labs(x = "Season", y="", subtitle="Max temperature (C)")+
  scale_fill_manual(values=c("#40B0A6", "#E1BE6A")) +
  scale_color_manual(values=c("#40B0A6", "#E1BE6A")) +
  #facet_grid(sex~season2)+
  facet_grid(~year)+
  theme_degu() +
  theme(axis.text.x = element_text(angle = 0, vjust = 0),
         legend.position="bottom",        
         legend.title = element_blank(),
         axis.text.x.bottom = element_text(size = 12),
         strip.background  = element_blank(),
         strip.text  = element_blank(),
         panel.grid.major = element_blank(),
         panel.border = element_blank(),
         #axis.ticks = element_blank(),
         panel.grid.minor.x=element_blank(),
         panel.grid.major.x=element_blank() )
plot_tempM

plot_lai<- ggplot(covars_real , aes(x = season2, y =lai_avg, group = season))+
  geom_col(aes(color=season, fill=season))+
  labs(x = "Season", y="", subtitle="Leaf area index")+
  scale_fill_manual(values=c("#40B0A6", "#E1BE6A")) +
  scale_color_manual(values=c("#40B0A6", "#E1BE6A")) +
  #facet_grid(sex~season2)+
  facet_grid(~year)+
  theme_degu() +
  theme(axis.text.x = element_text(angle = 0, vjust = 0),
         legend.position="bottom",        
         legend.title = element_blank(),
         axis.text = element_text(size = 12),
         strip.background  = element_blank(),
         strip.text  = element_blank(),
         panel.grid.major = element_blank(),
         panel.border = element_blank(),
         #axis.ticks = element_blank(),
         panel.grid.minor.x=element_blank(),
         panel.grid.major.x=element_blank() )
plot_lai

plot_et<- ggplot(covars_real , aes(x = season2, y =et_avg, group = season))+
  geom_col(aes(color=season, fill=season))+
  labs(x = "Season", y="", subtitle="Evapotranspiration")+
  scale_fill_manual(values=c("#40B0A6", "#E1BE6A")) +
  scale_color_manual(values=c("#40B0A6", "#E1BE6A")) +
  facet_grid(~year)+
  theme_degu() +
  theme(axis.text.x = element_text(angle = 0, vjust = 0),
         legend.position="bottom",        
         legend.title = element_blank(),
         axis.text = element_text(size = 12),
         strip.background  = element_blank(),
        strip.text  = element_blank(),
         panel.grid.major = element_blank(),
         panel.border = element_blank(),
         #axis.ticks = element_blank(),
         panel.grid.minor.x=element_blank(),
         panel.grid.major.x=element_blank() )
plot_et

```





