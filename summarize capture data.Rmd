---
title: "summarize capture data"
author: "Annemarie van der Marel"
date: "2023-10-03"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)

sessionInfo()
```

# import data

```{r import}

trap <- read.csv("./data/degu_capture_09-20.csv")
    #,col_types = cols(date = col_date(format = "%Y-%m-%d"))) 

str(trap)

```

# seasons


<!-- ```{r julian dates} -->
<!-- dates <- read_csv("./data/dates.csv", col_types = cols(date = col_date(format = "%Y-%m-%d"))) -->

<!-- trap_dates <- trap %>% select(julian_date, date) %>% distinct() -->

<!-- dates <- dates %>% left_join(trap_dates)  -->


<!-- ``` -->


<!-- ```{r number of days} -->
<!-- # max -->

<!-- maxdays <- dates %>%  -->
<!--   pivot_wider(id_cols=period,  -->
<!--               names_from=time,  -->
<!--               values_from = julian_date  -->
<!--               ) %>% -->
<!--   mutate(length=end-start) -->

<!-- maxdays -->

<!-- ``` -->




# summarize capture dates


```{r field season}

fieldseason <- trap %>%
  group_by(season, year) %>%
  summarize(start = min(date), end= max(date)) %>%
  mutate(status="trapping")  


```


## fall distribution

```{r fall trapping distribution}

fall <- trap %>%
  filter( season=="fall") %>% 
  group_by(year) %>%
  summarize(start=min(date), end=max(date),
            start.jd=min(julian_date), end.jd=max(julian_date))

range(fall$julian_date)

trapdist_fall <- trap %>%
  filter( season=="fall") %>%  
  ggplot(aes(julian_date)) +
  geom_histogram(stat = "count") +
  facet_wrap(~year, #*season
             nrow = 12, ncol = 1,
             strip.position = "right") +
  scale_x_continuous(limits = c(124, 203), n.breaks = 8 ) +
  geom_vline(xintercept = c(155, 174), color="orange")
trapdist_fall 

ndays_fallwindow<- 174-155

```

fall dates trapping:
2013-06-03 = julian 155
2009-06-23 = julian 174

max of 19 day period

## spring distribution
```{r spring trapping distribution}
spring <- trap %>%
  filter(season=="spring") %>% 
  group_by(year) %>%
  summarize(start=min(julian_date), end=max(julian_date),
            start.jd=min(julian_date), end.jd=max(julian_date))

range(spring$julian_date)

trapdist_spring <- trap %>%
  filter(season=="spring") %>%
  ggplot( aes(julian_date)) +
  geom_histogram(stat = "count") +
  facet_wrap(~year, #*season
             nrow = 12, ncol = 1,
             strip.position = "right") +
  scale_x_continuous(limits = c(230, 320), n.breaks = 9 ) +      # fall trapping
  geom_vline(xintercept = c(244, 300), color="lightgreen") 
trapdist_spring

ndays_springwindow<- 300-244

```


spring dates trapping:
2009-09-01 = julian 244
2013-10-26 = julian 300

max of 59 days


## breeding season
Look at dates of mating, gestation, lactation, first day of juvenile emergence


```{r}
levels(as.factor(trap$breeding_status_2))
#levels(as.factor(trap$notes))
```
We do not have much data on mating, just one copulatory plug observation. 


```{r gestation}

levels(as.factor(trap$breeding_status_2))

check_gestation <- trap %>%
  group_by(breeding_status_2) %>%
  tally()
write.csv(check_gestation, "breeding_status.csv") 


gestation <- c("Preñada", "Prenada?","prenada?", "P", "preñada", "preñada?" , "preñada???" )

check_pregnancy <- trap %>%
  filter(breeding_status_2 %in% gestation)

pregnancy <- trap %>%
  filter(breeding_status_2 %in% gestation) %>%
  group_by(season, year) %>%
  summarize(start = min(date), end= max(date),
            start.jd=min(julian_date), end.jd=max(julian_date)) %>%
  mutate(status="gestation") 



```
Gestation start, at least observed, was in fall earliest on 2018-07-02 (julian 185) and latest 	
2017-07-11 (julian 194). 

first in spring was 2018-09-03 (248) and the last one in spring was 2009-10-25 (julian 298). 


```{r lactation}
levels(as.factor(trap$breeding_status_2))

milk <- c("lactante reciente?", "lactante, X", "lactante", "lactante, no preñada", 
          "lactante, preñada?", "lactante?, X", "lactante reciente", "lactante, no preñada?",
          "lactante, secresión sang.")

lactation <- trap %>%
  filter(breeding_status_2 %in% milk) %>%
  group_by(season, year) %>%
  summarize(start = min(date), end= max(date),
            start.jd=min(julian_date), end.jd=max(julian_date)) %>%
  mutate(status="lactation") 


```

Lactation start, at least observed, was latest on 2011-09-14 (Julian 257) and stopped earliest on 2010-10-19 (julian 292. 


```{r juvenile emergence}

levels(as.factor(trap$status))
levels(as.factor(trap$age))

# pupemerge <- trap %>%
#   filter(notes=="pup") %>%
#   arrange(julian_date) %>%
#   group_by(year) %>%
#   slice(1, n()) %>%
#   ungroup

pupemerge <- trap %>%
  filter(status=="new", grepl('pup', notes)) %>%
  group_by(season, year) %>%
  summarize(start = min(date), end= max(date),
            start.jd=min(julian_date), end.jd=max(julian_date)) 

check <- trap %>%
  filter(year==2017)
pupemerge.age <- trap %>%
  filter(status=="new", age %in% c("P", "Pup")) %>%
  group_by(season, year) %>%
  summarize(start = min(date), end= max(date),
            start.jd=min(julian_date), end.jd=max(julian_date)) 

pups <- bind_rows(pupemerge, 
                  pupemerge.age) %>%
  mutate(status="juvenile_emergence") 
  
  
```

pup emergence start was latest on 2019-10-04 (julian 279) . 

```{r weaning}

postlactation <- c("post lactante, no preñada?", "postlactante, preñada", 
                   "post lactante, preñada?", "post lactante", "post lactante, no preñada?!",
                   "post lactante, X", "postlactante", "postlactante, preñada?", 
                   "post lactante, no preñada", "post lactante?", "postlactante, no preñada", 
                   "postlactante, X" )

weaning <- trap %>%
  filter(breeding_status_2 %in% postlactation) %>%
  group_by(season, year) %>%
  summarize(start = min(date), end= max(date),
            start.jd=min(julian_date), end.jd=max(julian_date)) %>%
  mutate(status="weaning") 

```
weaning start, at least observed, was latest on 2009-10-21 (294) and stopped earliest on 2013-10-26 (300). 


```{r combine dates}
 
fieldseason_dates <- bind_rows(fieldseason, 
                              pregnancy, 
                              lactation, 
                              pups, 
                              weaning)

write.csv(fieldseason_dates, "./data/fieldseason_dates.csv")

```




# Plot distribution of trapping


Distribution of trapping (histogram of trapping days) years 2009-2020

```{r plot}

trapdist <- trap %>%
  #filter(!year %in% c(2009, 2010)) %>%
  ggplot( aes(julian_date)) +
  geom_histogram(stat = "count") +
  labs(x="julian date") +
  #theme_classic()+
  facet_wrap(~year, #*season
             nrow = 12, ncol = 1, strip.position = "right") +
  scale_x_continuous(limits = c(130, 320), n.breaks = 20 ) +
  geom_vline(xintercept = c(155, 174), color="orange") +      # fall trapping / select fall
  #geom_text(x=157.5, y = 120, label="fall", color="orange", size=3) +
  geom_vline(xintercept = c(244, 300), color="lightgreen") +  # spring trapping
  #geom_text(x=247, y = 120, label="spring", color="lightgreen", size=3) +
  geom_vline(xintercept = c(194, 248), color="pink") +        # gestation 
  #geom_text(x=197, y = 120, label="gest", color="pink", size=3) +
  geom_vline(xintercept = c(257, 292), color="lightblue") +   # lactation
  #geom_text(x=260, y = 120, label="lact", color="lightblue", size=3) +
  geom_vline(xintercept = c(279), color="yellow") +            # juvenile emergence
  geom_vline(xintercept = c(279, 298), color="red")            # select spring
  #geom_text(x=282, y = 120, label="pup", color="yellow", size=3) 
  #geom_vline(xintercept = c(294, 300), color="purple")        # weaning
trapdist

ggsave( "./data/plot_trapping distribution.png")

```


# choose 19 day periods
max of 19 day period


fall dates trapping:
2013-06-03 = julian 155
2009-06-23 = julian 174

spring, perhaps from juvenile emergence onward
2019-10-04 = julian 279 + 19
2019-10-23 = julian 298 

## fall distribution

```{r fall select}



select_fall <- trap %>%
  filter( season=="fall", between(julian_date, 155, 174)) %>%  
  ggplot(aes(julian_date)) +
  geom_histogram(stat = "count") +
  facet_wrap(~year, #*season
             nrow = 12, ncol = 1,
             strip.position = "right") +
  scale_x_continuous(limits = c(150, 180), n.breaks = 8 ) 
select_fall 



```




## spring distribution
```{r spring select}

# choose day of latest juvenile emergence + 19

select_spring <- trap %>%
  filter(season=="spring", between(julian_date, 279, 298)) %>%
  ggplot( aes(julian_date)) +
  geom_histogram(stat = "count") +
  facet_wrap(~year, #*season
             nrow = 12, ncol = 1,
             strip.position = "right") +
  scale_x_continuous(limits = c(275, 300), n.breaks = 9 ) 
select_spring



```




